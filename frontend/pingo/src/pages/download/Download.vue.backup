<template>
  <div class="min-h-screen relative overflow-hidden bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900">
    <!-- Enhanced Background with Subtle Effects -->
    <div class="fixed inset-0">
      <!-- Subtle animated gradient overlay -->
      <div class="absolute inset-0 bg-gradient-to-br from-blue-400/5 via-purple-400/5 to-pink-400/5 animate-gradient-shift"></div>

      <!-- Floating orbs for ambient effect -->
      <div class="absolute top-20 left-20 w-72 h-72 bg-gradient-to-r from-blue-400/10 to-purple-400/10 rounded-full blur-3xl animate-float-slow"></div>
      <div class="absolute bottom-20 right-20 w-96 h-96 bg-gradient-to-r from-purple-400/8 to-pink-400/8 rounded-full blur-3xl animate-float-slower"></div>
      <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-gradient-to-r from-indigo-400/6 to-blue-400/6 rounded-full blur-3xl animate-float"></div>
    </div>

    <!-- Main Content -->
    <div class="relative z-10 w-full min-h-screen flex items-center justify-center p-6 lg:p-8">

      <!-- Enhanced Content Card -->
      <div class="w-full max-w-5xl">
        <!-- Glass morphism container with enhanced styling -->
        <div class="backdrop-blur-xl bg-white/80 dark:bg-slate-900/80 border border-white/20 dark:border-slate-700/50 rounded-3xl shadow-2xl shadow-black/10 dark:shadow-black/40 overflow-hidden">

          <div class="relative p-8 lg:p-12">
          
          <!-- Enhanced Loading State -->
          <div v-if="loading" class="text-center space-y-10 animate-fade-in">
            <!-- Modern loading spinner -->
            <div class="relative mx-auto w-32 h-32">
              <div class="absolute inset-0 rounded-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 p-1 animate-spin">
                <div class="w-full h-full rounded-full bg-white dark:bg-slate-900"></div>
              </div>
              <div class="absolute inset-4 rounded-full bg-gradient-to-r from-blue-400 to-purple-400 animate-spin-reverse">
                <div class="w-full h-full rounded-full bg-white dark:bg-slate-900"></div>
              </div>
              <div class="absolute inset-8 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 animate-pulse">
                <div class="w-full h-full rounded-full bg-white dark:bg-slate-900 flex items-center justify-center">
                  <div class="w-3 h-3 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full animate-bounce"></div>
                </div>
              </div>
            </div>

            <div class="space-y-4">
              <h1 class="text-4xl lg:text-5xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent animate-gradient-x">
                Preparing your files
              </h1>
              <p class="text-xl text-slate-600 dark:text-slate-400 animate-fade-in" style="animation-delay: 0.3s;">
                Setting up your secure download experience
              </p>
              <!-- Progress indicator -->
              <div class="flex justify-center mt-6">
                <div class="flex space-x-2">
                  <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                  <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                  <div class="w-3 h-3 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Enhanced Content State -->
          <div v-else-if="files.length > 0" class="space-y-12">

            <!-- Modern Header Section -->
            <div class="text-center space-y-8 animate-fade-in" style="animation-delay: 0.1s;">
              <!-- Status badge -->
              <div class="inline-flex items-center gap-3 px-6 py-3 rounded-full bg-gradient-to-r from-emerald-500/10 to-teal-500/10 border border-emerald-500/20 backdrop-blur-sm">
                <div class="w-3 h-3 bg-gradient-to-r from-emerald-400 to-teal-400 rounded-full animate-pulse"></div>
                <span class="text-sm font-semibold bg-gradient-to-r from-emerald-600 to-teal-600 bg-clip-text text-transparent">
                  {{ files.length }} file{{ files.length > 1 ? 's' : '' }} ready for download
                </span>
              </div>

              <!-- Main title with enhanced gradient -->
              <div class="space-y-4">
                <h1 class="text-5xl lg:text-7xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent animate-gradient-x leading-tight">
                  Download Files
                </h1>
                <p class="text-xl lg:text-2xl text-slate-600 dark:text-slate-400 animate-fade-in" style="animation-delay: 0.3s;">
                  Secure, instant, and beautifully organized
                </p>
              </div>
            </div>

            <!-- Enhanced Uploader Card -->
            <div v-if="uploader" class="animate-fade-in" style="animation-delay: 0.2s;">
              <div class="relative overflow-hidden backdrop-blur-xl bg-gradient-to-r from-white/60 to-white/40 dark:from-slate-800/60 dark:to-slate-900/40 border border-white/30 dark:border-slate-700/50 rounded-3xl p-8 shadow-xl shadow-black/5 dark:shadow-black/20">

                <!-- Subtle background pattern -->
                <div class="absolute inset-0 opacity-5">
                  <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full blur-2xl"></div>
                  <div class="absolute bottom-0 left-0 w-24 h-24 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full blur-2xl"></div>
                </div>

                <div class="relative flex flex-col lg:flex-row lg:items-center gap-8">

                  <!-- Enhanced Avatar Section -->
                  <div class="flex flex-col items-center lg:items-start gap-4">
                    <div class="relative group">
                      <!-- Avatar with enhanced styling -->
                      <div class="w-24 h-24 rounded-2xl overflow-hidden backdrop-blur-sm border-2 border-white/50 dark:border-slate-600/50 shadow-lg ring-4 ring-white/20 dark:ring-slate-700/30 transition-all duration-300 group-hover:ring-white/40 dark:group-hover:ring-slate-600/50">
                        <img v-if="uploader.avatar"
                             :src="getAssetUrl(uploader.avatar)"
                             :alt="uploader.username"
                             class="w-full h-full object-cover transition-all duration-500 group-hover:scale-110"
                             @error="handleAvatarError" />
                        <div v-else class="w-full h-full bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center">
                          <span class="text-white text-3xl font-bold">{{ uploader.username.charAt(0).toUpperCase() }}</span>
                        </div>
                      </div>

                      <!-- Enhanced online indicator -->
                      <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-gradient-to-r from-emerald-400 to-teal-400 rounded-full border-4 border-white dark:border-slate-900 shadow-lg animate-pulse">
                        <div class="w-full h-full bg-gradient-to-r from-emerald-300 to-teal-300 rounded-full animate-ping"></div>
                      </div>

                      <!-- Decorative ring -->
                      <div class="absolute -inset-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-2xl opacity-20 group-hover:opacity-30 transition-opacity duration-300 -z-10"></div>
                    </div>

                    <!-- Quick stats -->
                    <div class="flex gap-2">
                      <div class="px-3 py-1 bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/20 rounded-full text-xs font-semibold text-blue-600 dark:text-blue-400">
                        {{ files.length }} files
                      </div>
                      <div class="px-3 py-1 bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20 rounded-full text-xs font-semibold text-purple-600 dark:text-purple-400">
                        {{ formatTotalSize() }}
                      </div>
                    </div>
                  </div>

                  <!-- Enhanced User Info -->
                  <div class="flex-1 space-y-4">
                    <div>
                      <h3 class="text-3xl font-bold bg-gradient-to-r from-slate-900 to-slate-700 dark:from-white dark:to-slate-300 bg-clip-text text-transparent mb-2">
                        {{ uploader.username }}
                      </h3>
                      <p class="text-lg text-slate-600 dark:text-slate-400">
                        {{ uploader.email }}
                      </p>
                    </div>

                    <!-- Enhanced Stats Grid -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                      <div class="bg-gradient-to-br from-blue-500/10 to-blue-600/10 border border-blue-500/20 rounded-2xl p-4 text-center backdrop-blur-sm">
                        <div class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-blue-500 bg-clip-text text-transparent">{{ files.length }}</div>
                        <div class="text-sm text-slate-600 dark:text-slate-400">Files</div>
                      </div>

                      <div class="bg-gradient-to-br from-purple-500/10 to-purple-600/10 border border-purple-500/20 rounded-2xl p-4 text-center backdrop-blur-sm">
                        <div class="text-lg font-bold bg-gradient-to-r from-purple-600 to-purple-500 bg-clip-text text-transparent">{{ formatTotalSize() }}</div>
                        <div class="text-sm text-slate-600 dark:text-slate-400">Total Size</div>
                      </div>

                      <div v-if="uploader.expirationDate" class="bg-gradient-to-br from-emerald-500/10 to-teal-500/10 border border-emerald-500/20 rounded-2xl p-4 text-center backdrop-blur-sm">
                        <div class="text-lg font-bold" :class="formatExpirationDate(uploader.expirationDate).isExpired ? 'text-red-500' : 'bg-gradient-to-r from-emerald-600 to-teal-500 bg-clip-text text-transparent'">
                          {{ formatExpirationDate(uploader.expirationDate).timeLeft }}
                        </div>
                        <div class="text-sm text-slate-600 dark:text-slate-400">Expires</div>
                      </div>

                      <div class="bg-gradient-to-br from-pink-500/10 to-rose-500/10 border border-pink-500/20 rounded-2xl p-4 text-center backdrop-blur-sm">
                        <div class="text-2xl font-bold bg-gradient-to-r from-pink-600 to-rose-500 bg-clip-text text-transparent">âœ“</div>
                        <div class="text-sm text-slate-600 dark:text-slate-400">Secure</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Download All Button -->
            <div class="text-center animate-fade-in" style="animation-delay: 0.3s;">
              <div class="relative group">
                <!-- Background glow effect -->
                <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 rounded-3xl blur opacity-25 group-hover:opacity-40 transition-opacity duration-300"></div>

                <button
                  @click="downloadAll"
                  :disabled="downloadingAll"
                  class="relative px-10 py-5 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white font-bold text-xl rounded-3xl transition-all duration-300 hover:scale-105 hover:shadow-2xl hover:shadow-purple-500/25 disabled:opacity-50 disabled:hover:scale-100 shadow-xl shadow-blue-500/20"
                >
                  <span v-if="downloadingAll" class="flex items-center justify-center gap-4">
                    <div class="w-6 h-6 border-3 border-white/30 border-t-white rounded-full animate-spin"></div>
                    <span>Downloading All Files...</span>
                  </span>
                  <span v-else class="flex items-center gap-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span>Download All Files</span>
                    <span class="text-lg opacity-80">({{ formatTotalSize() }})</span>
                  </span>
                </button>
              </div>
            </div>

            <!-- Enhanced Files List -->
            <div class="space-y-6 animate-fade-in" style="animation-delay: 0.4s;">
              <div class="text-center">
                <h2 class="text-3xl font-bold bg-gradient-to-r from-slate-900 to-slate-700 dark:from-white dark:to-slate-300 bg-clip-text text-transparent mb-2">
                  Files ({{ files.length }})
                </h2>
                <p class="text-slate-600 dark:text-slate-400">Choose individual files or download everything</p>
              </div>

              <div class="grid gap-4 md:gap-6">
                <div v-for="(file, index) in files" :key="`file-${index}-${file.name}`"
                     class="group relative overflow-hidden backdrop-blur-xl bg-gradient-to-r from-white/60 to-white/40 dark:from-slate-800/60 dark:to-slate-900/40 border border-white/30 dark:border-slate-700/50 rounded-3xl p-6 shadow-xl shadow-black/5 dark:shadow-black/20 transition-all duration-300 hover:scale-[1.02] hover:shadow-2xl hover:shadow-purple-500/10">

                  <!-- Subtle background pattern -->
                  <div class="absolute inset-0 opacity-5">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full blur-xl"></div>
                  </div>

                  <div class="relative flex flex-col lg:flex-row lg:items-center gap-6">

                    <!-- Enhanced File Icon and Info -->
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                      <div class="relative group/icon">
                        <!-- File icon with enhanced styling -->
                        <div class="w-16 h-16 rounded-2xl overflow-hidden backdrop-blur-sm border-2 border-white/50 dark:border-slate-600/50 shadow-lg ring-4 ring-white/20 dark:ring-slate-700/30 transition-all duration-300 group-hover/icon:ring-white/40 dark:group-hover/icon:ring-slate-600/50">
                          <div class="w-full h-full bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center">
                            <img
                              :src="getFileIconPath(file.name)"
                              :alt="getFileIconAltText(file.name)"
                              class="w-8 h-8 object-contain transition-transform duration-300 group-hover/icon:scale-110"
                            />
                          </div>
                        </div>
                        <!-- Decorative ring -->
                        <div class="absolute -inset-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-2xl opacity-0 group-hover/icon:opacity-20 transition-opacity duration-300 -z-10"></div>
                      </div>

                      <!-- File details -->
                      <div class="flex-1 min-w-0">
                        <h3 class="text-xl font-bold truncate mb-1" :class="isDark ? 'text-white' : 'text-slate-900'" :title="file.name">
                          {{ file.name }}
                        </h3>
                        <div class="flex items-center gap-3 text-sm">
                          <span class="px-3 py-1 bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/20 rounded-full text-blue-600 dark:text-blue-400 font-medium">
                            {{ formatFileSize(file.size) }}
                          </span>
                          <span class="px-3 py-1 bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/20 rounded-full text-purple-600 dark:text-purple-400 font-medium">
                            {{ getFileExtension(file.name).toUpperCase() }}
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- Enhanced Action Buttons -->
                    <div class="flex flex-wrap items-center gap-3 lg:flex-nowrap">

                      <!-- Preview Button -->
                      <button v-if="canPreview(file)"
                              @click="togglePreview(index)"
                              class="group/btn relative px-4 py-3 rounded-2xl transition-all duration-200 hover:scale-105 flex-1 lg:flex-none"
                              :class="previewingFiles.has(index)
                                ? 'bg-gradient-to-r from-red-500/20 to-pink-500/20 border border-red-500/30 text-red-600 dark:text-red-400'
                                : 'bg-gradient-to-r from-emerald-500/20 to-teal-500/20 border border-emerald-500/30 text-emerald-600 dark:text-emerald-400'">
                        <div class="flex items-center justify-center gap-2">
                          <svg v-if="!previewingFiles.has(index)" class="w-5 h-5 transition-transform duration-200 group-hover/btn:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                          </svg>
                          <svg v-else class="w-5 h-5 transition-transform duration-200 group-hover/btn:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                          </svg>
                          <span class="hidden lg:inline font-medium">{{ previewingFiles.has(index) ? 'Hide' : 'Preview' }}</span>
                        </div>
                      </button>

                      <!-- Full-page View Button for Documents -->
                      <button v-if="isDocument(file)"
                              @click="openFullPageView(file)"
                              class="group/btn px-4 py-3 bg-gradient-to-r from-orange-500/20 to-amber-500/20 border border-orange-500/30 text-orange-600 dark:text-orange-400 rounded-2xl transition-all duration-200 hover:scale-105 flex-1 lg:flex-none"
                              title="Open in new tab">
                        <div class="flex items-center justify-center gap-2">
                          <svg class="w-5 h-5 transition-transform duration-200 group-hover/btn:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4a1 1 0 011-1h4m0 0l-3 3m3-3v3M20 8V4a1 1 0 00-1-1h-4m0 0l3 3m-3-3v3M4 16v4a1 1 0 001 1h4m0 0l-3-3m3 3h-3M20 16v4a1 1 0 01-1 1h-4m0 0l3-3m-3 3h3"/>
                          </svg>
                          <span class="hidden lg:inline font-medium">View</span>
                        </div>
                      </button>

                      <!-- Enhanced Download Button -->
                      <button @click="downloadFile(file, index)"
                              :disabled="downloadingStates[index]"
                              class="group/btn relative px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-2xl transition-all duration-200 hover:scale-105 disabled:opacity-50 flex-1 lg:flex-none shadow-lg shadow-blue-500/20">
                        <span v-if="downloadingStates[index]" class="flex items-center justify-center gap-2">
                          <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                          <span class="hidden lg:inline">Downloading</span>
                          <span class="lg:hidden">...</span>
                        </span>
                        <span v-else class="flex items-center gap-2">
                          <svg class="w-4 h-4 transition-transform duration-200 group-hover/btn:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                          </svg>
                          <span class="font-medium">Download</span>
                        </span>
                      </button>
                    </div>
                  </div>

                  <!-- Enhanced Preview Section -->
                  <div v-if="previewingFiles.has(index)" class="mt-6 pt-6 border-t border-white/20 dark:border-slate-700/50">
                    <div class="bg-gradient-to-r from-slate-50/50 to-slate-100/50 dark:from-slate-800/50 dark:to-slate-700/50 rounded-2xl p-6 backdrop-blur-sm border border-white/30 dark:border-slate-600/30">

                      <!-- Image preview -->
                      <div v-if="['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(getFileExtension(file.name))">
                        <div class="text-center">
                          <img
                            :src="getFilePreviewUrl(file.name)"
                            :alt="file.name"
                            class="max-w-full max-h-96 mx-auto rounded-2xl shadow-2xl border border-white/50 dark:border-slate-600/50 transition-transform duration-300 hover:scale-105"
                            @error="handlePreviewError" />
                        </div>
                      </div>

                      <!-- Video preview -->
                      <div v-else-if="getFileExtension(file.name) === 'mp4'">
                        <div class="text-center">
                          <video
                            :src="getFilePreviewUrl(file.name)"
                            controls
                            class="max-w-full max-h-96 mx-auto rounded-2xl shadow-2xl border border-white/50 dark:border-slate-600/50"
                            preload="metadata">
                            Your browser does not support the video tag.
                          </video>
                        </div>
                      </div>

                      <!-- Audio preview -->
                      <div v-else-if="['mp3', 'wav', 'flac'].includes(getFileExtension(file.name))">
                        <div class="text-center space-y-4">
                          <div class="w-20 h-20 mx-auto bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-lg">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                            </svg>
                          </div>
                          <audio
                            :src="getFilePreviewUrl(file.name)"
                            controls
                            class="w-full max-w-md mx-auto"
                            preload="metadata">
                            Your browser does not support the audio tag.
                          </audio>
                        </div>
                      </div>

                      <!-- PDF preview -->
                      <div v-else-if="getFileExtension(file.name) === 'pdf'">
                        <div class="text-center">
                          <iframe
                            :src="getFilePreviewUrl(file.name)"
                            class="w-full max-w-2xl mx-auto h-96 rounded-2xl shadow-2xl border border-white/50 dark:border-slate-600/50"
                            title="PDF Preview">
                          </iframe>
                        </div>
                      </div>

                      <!-- Other file types -->
                      <div v-else class="text-center py-8">
                        <div class="w-16 h-16 mx-auto bg-gradient-to-br from-slate-400 to-slate-500 rounded-2xl flex items-center justify-center mb-4">
                          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                          </svg>
                        </div>
                        <p class="text-slate-600 dark:text-slate-400 font-medium">
                          Preview not available for this file type
                        </p>
                        <p class="text-sm text-slate-500 dark:text-slate-500 mt-1">
                          Download the file to view its contents
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Error State -->
            <div v-else class="text-center space-y-8 animate-fade-in">
              <div class="relative mx-auto w-32 h-32">
                <!-- Error icon with enhanced styling -->
                <div class="absolute inset-0 bg-gradient-to-r from-red-500 to-pink-500 rounded-full p-1 animate-pulse">
                  <div class="w-full h-full bg-white dark:bg-slate-900 rounded-full flex items-center justify-center">
                    <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                  </div>
                </div>
              </div>

              <div class="space-y-6">
                <div>
                  <h1 class="text-4xl lg:text-5xl font-bold bg-gradient-to-r from-red-600 to-pink-600 bg-clip-text text-transparent mb-4">
                    Share Not Found
                  </h1>
                  <p class="text-xl text-slate-600 dark:text-slate-400 max-w-md mx-auto">
                    This share may have expired or been removed by the uploader
                  </p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                  <button
                    @click="$router.push('/')"
                    class="group relative px-8 py-4 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-semibold rounded-2xl transition-all duration-300 hover:scale-105 shadow-lg shadow-slate-500/20"
                  >
                    <span class="flex items-center gap-3">
                      <svg class="w-5 h-5 transition-transform duration-200 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                      </svg>
                      Go Back Home
                    </span>
                  </button>

                  <button
                    @click="$router.go(-1)"
                    class="px-6 py-3 bg-gradient-to-r from-slate-100 to-slate-200 hover:from-slate-200 hover:to-slate-300 dark:from-slate-700 dark:to-slate-600 dark:hover:from-slate-600 dark:hover:to-slate-500 text-slate-700 dark:text-slate-300 font-medium rounded-2xl transition-all duration-300 hover:scale-105"
                  >
                    <span class="flex items-center gap-2">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                      </svg>
                      Go Back
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Success Message -->
    <div v-if="message" 
         class="fixed bottom-6 right-6 p-4 rounded-2xl shadow-2xl z-50 backdrop-blur-xl border transition-all duration-300"
         :class="message.type === 'success' 
           ? (isDark ? 'bg-green-500/20 border-green-500/30 text-green-400' : 'bg-green-100 border-green-200 text-green-700')
           : (isDark ? 'bg-red-500/20 border-red-500/30 text-red-400' : 'bg-red-100 border-red-200 text-red-700')">
      {{ message.text }}
    </div>

    <!-- GitHub Icon -->
    <a 
      href="https://github.com/R8bert/PInGO-Share" 
      target="_blank" 
      rel="noopener noreferrer" 
      class="fixed bottom-4 left-4 z-40 p-2 rounded-lg backdrop-blur-sm transition-all duration-300 hover:scale-110"
      :class="isDark ? 'text-gray-400 hover:text-white bg-white/5' : 'text-gray-600 hover:text-gray-900 bg-white/50'"
      title="View GitHub Repository"
    >
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
      </svg>
    </a>

</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import { useTheme } from '../../composables/useTheme'
import { useIcons } from '../../composables/useIcons'
import { getApiUrl, getAssetUrl } from '../../utils/apiUtils'
import axios from 'axios'

// Interfaces
interface FileInfo {
  name: string
  size: number
}

interface UploaderInfo {
  username: string
  email: string
  avatar?: string
  expirationDate?: string
}

interface Message {
  text: string
  type: 'success' | 'error'
}

const { isDark } = useTheme()
const { 
  getFileIcon, 
  getFileIconAlt,
  getFileExtension 
} = useIcons()
const route = useRoute()

// Galaxy loading state
const galaxyLoaded = ref(false)

// Helper methods for file icons
const getFileIconPath = (filename: string) => {
  return getFileIcon(filename)
}

const getFileIconAltText = (filename: string) => {
  return getFileIconAlt(filename)
}

// State
const loading = ref(true)
const files = ref<FileInfo[]>([])
const uploader = ref<UploaderInfo | null>(null)
const downloadingAll = ref(false)
const downloadingStates = ref<Record<number, boolean>>({})
const message = ref<Message | null>(null)
const previewingFiles = ref<Set<number>>(new Set())

// Computed properties for API URLs
const getFilePreviewUrl = (fileName: string) => {
  return getApiUrl(`/file/${route.params.id}/${fileName}?preview=true`)
}

const getFileDownloadUrl = (fileName: string) => {
  return getApiUrl(`/file/${route.params.id}/${fileName}`)
}

const getDownloadAllUrl = () => {
  return getApiUrl(`/download/${route.params.id}`)
}

// Methods
const fetchFiles = async () => {
  try {
    const response = await axios.get(getApiUrl(`files/${route.params.id}`))
    files.value = response.data.files || []
    uploader.value = response.data.uploader || null
    loading.value = false
  } catch (error) {
    console.error('Error fetching files:', error)
    message.value = { text: 'Share not found', type: 'error' }
    loading.value = false
  }
}

const downloadFile = async (file: FileInfo, index: number) => {
  downloadingStates.value[index] = true
  
  try {
    const response = await axios.get(
      getFileDownloadUrl(file.name),
      { responseType: 'blob' }
    )
    
    const url = window.URL.createObjectURL(new Blob([response.data]))
    const link = document.createElement('a')
    link.href = url
    link.setAttribute('download', file.name)
    document.body.appendChild(link)
    link.click()
    link.remove()
    window.URL.revokeObjectURL(url)
    
    showMessage('File downloaded successfully!', 'success')
  } catch (error) {
    console.error('Download error:', error)
    showMessage('Download failed. Please try again.', 'error')
  } finally {
    downloadingStates.value[index] = false
  }
}

const downloadAll = async () => {
  downloadingAll.value = true
  
  try {
    const response = await axios.get(
      getDownloadAllUrl(),
      { responseType: 'blob' }
    )
    
    const url = window.URL.createObjectURL(new Blob([response.data]))
    const link = document.createElement('a')
    link.href = url
    link.setAttribute('download', `share-${route.params.id}.zip`)
    document.body.appendChild(link)
    link.click()
    link.remove()
    window.URL.revokeObjectURL(url)
    
    showMessage('All files downloaded successfully!', 'success')
  } catch (error) {
    console.error('Download all error:', error)
    showMessage('Download failed. Please try again.', 'error')
  } finally {
    downloadingAll.value = false
  }
}

const togglePreview = (index: number) => {
  if (previewingFiles.value.has(index)) {
    previewingFiles.value.delete(index)
  } else {
    previewingFiles.value.add(index)
  }
}

const canPreview = (file: FileInfo): boolean => {
  const ext = getFileExtension(file.name)
  return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'mp4', 'mp3', 'wav', 'flac', 'pdf'].includes(ext)
}

const isDocument = (file: FileInfo): boolean => {
  const ext = getFileExtension(file.name)
  return ['pdf', 'txt', 'md', 'markdown', 'doc', 'docx'].includes(ext)
}

const openFullPageView = (file: FileInfo) => {
  const fileUrl = getFileDownloadUrl(file.name)
  window.open(fileUrl, '_blank')
}

const formatFileSize = (bytes: number): string => {
  if (bytes === 0) return '0 Bytes'
  const k = 1024
  const sizes = ['Bytes', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

const formatTotalSize = (): string => {
  const total = files.value.reduce((sum, file) => sum + file.size, 0)
  return formatFileSize(total)
}

const formatExpirationDate = (dateString: string) => {
  const date = new Date(dateString)
  const now = new Date()
  const isExpired = date < now
  
  if (isExpired) {
    return { text: 'Expired', isExpired: true, timeLeft: 'Expired' }
  }
  
  const diffTime = date.getTime() - now.getTime()
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))
  const diffHours = Math.ceil(diffTime / (1000 * 60 * 60))
  const diffMinutes = Math.ceil(diffTime / (1000 * 60))
  
  let timeLeft = ''
  if (diffDays > 1) {
    timeLeft = `${diffDays}d`
  } else if (diffHours > 1) {
    timeLeft = `${diffHours}h`
  } else if (diffMinutes > 1) {
    timeLeft = `${diffMinutes}m`
  } else {
    timeLeft = '<1m'
  }
  
  if (diffDays === 1) return { text: 'Expires today', isExpired: false, timeLeft }
  if (diffDays <= 7) return { text: `Expires in ${diffDays} days`, isExpired: false, timeLeft }
  
  return { text: `Expires ${date.toLocaleDateString()}`, isExpired: false, timeLeft }
}

const handleAvatarError = () => {
  if (uploader.value) {
    uploader.value.avatar = undefined
  }
}

const handlePreviewError = () => {
  console.log('Preview failed to load')
}

const showMessage = (text: string, type: 'success' | 'error') => {
  message.value = { text, type }
  setTimeout(() => {
    message.value = null
  }, 3000)
}

// Initialize
onMounted(() => {
  // Delay galaxy loading to prevent freeze
  setTimeout(() => {
    galaxyLoaded.value = true
  }, 100)
  
  fetchFiles()
})
</script>

<style scoped>
/* Enhanced animations for modern design */
.animate-fade-in {
  animation: fadeIn 0.8s ease-out forwards;
  opacity: 0;
  transform: translateY(30px);
}

@keyframes fadeIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in-word {
  animation: fadeInWord 0.6s ease-out forwards;
  opacity: 0;
  transform: translateY(20px);
}

@keyframes fadeInWord {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Gradient text animation */
.animate-gradient-x {
  background-size: 200% 200%;
  animation: gradientX 4s ease infinite;
}

@keyframes gradientX {
  0%, 100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}

/* Floating animations for background orbs */
.animate-float {
  animation: float 6s ease-in-out infinite;
}

.animate-float-slow {
  animation: float 8s ease-in-out infinite;
}

.animate-float-slower {
  animation: float 10s ease-in-out infinite;
}

@keyframes float {
  0%, 100% {
    transform: translateY(0px) rotate(0deg);
  }
  33% {
    transform: translateY(-20px) rotate(120deg);
  }
  66% {
    transform: translateY(10px) rotate(240deg);
  }
}

/* Gradient shift animation for background */
.animate-gradient-shift {
  background-size: 400% 400%;
  animation: gradientShift 15s ease infinite;
}

@keyframes gradientShift {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}

/* Custom spinner animations */
.animate-spin-reverse {
  animation: spin 2s linear infinite reverse;
}

.animate-spin-slow {
  animation: spin 4s linear infinite;
}

/* Pulse glow effect */
.pulse-glow {
  animation: pulseGlow 3s ease-in-out infinite;
}

@keyframes pulseGlow {
  0%, 100% {
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
  }
  50% {
    box-shadow: 0 0 40px rgba(59, 130, 246, 0.6), 0 0 60px rgba(147, 51, 234, 0.3);
  }
}

/* Hover effects */
.hover-lift {
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.hover-lift:hover {
  transform: translateY(-4px);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

/* Glass morphism effect */
.glass {
  backdrop-filter: blur(16px) saturate(180%);
  background-color: rgba(255, 255, 255, 0.75);
  border: 1px solid rgba(209, 213, 219, 0.3);
}

.glass-dark {
  backdrop-filter: blur(16px) saturate(180%);
  background-color: rgba(17, 24, 39, 0.75);
  border: 1px solid rgba(55, 65, 81, 0.3);
}
</style>
